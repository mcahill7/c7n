FROM python:3.9-alpine

ADD requirements.txt .
RUN apk upgrade --available
RUN apk add --no-cache bash git libgit2 \
    && apk add --no-cache --virtual .build-deps build-base libffi-dev libgit2-dev busybox-suid apk-cron dcron \
    && python -m pip install --upgrade pip \
    && python -m pip install --upgrade pipenv \
    && python -m pip install -r requirements.txt \
    && apk del .build-deps \
    && rm requirements.txt \
    && rm -rf ~/.cache/pip \

RUN mkdir -p /var/log/cron && mkdir -m 0644 -p /var/spool/cron/crontabs && touch /var/log/cron/cron.log && mkdir -m 0644 -p /etc/cron.d

#USER c7n
#WORKDIR /home/c7n
#CMD ["custodian", "version"]
#ENTRYPOINT [ "/bin/sh" ]
ADD crontab.txt /crontab.txt
ADD script.sh /script.sh
COPY entry.sh /entry.sh
#RUN /usr/bin/crontab /crontab.txt

CMD ["/entry.sh"]
